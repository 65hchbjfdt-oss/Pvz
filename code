<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ü–í–ó –°–∏–º—É–ª—è—Ç–æ—Ä</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
<style>
  :root {
    --bg: #0d0d0d;
    --surface: #1a1a1a;
    --surface2: #242424;
    --border: #2e2e2e;
    --accent: #ff6b35;
    --accent2: #ffb347;
    --text: #f0f0f0;
    --text2: #999;
    --green: #4caf50;
    --red: #f44336;
    --blue: #2196f3;
    --radius: 14px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  body { background: var(--bg); color: var(--text); font-family: 'Trebuchet MS', sans-serif; min-height: 100dvh; overflow-x: hidden; }

  /* ROLE SELECT */
  #roleScreen {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 100dvh; padding: 24px; gap: 20px;
    background: radial-gradient(ellipse at 50% 0%, #ff6b3520 0%, transparent 70%);
  }
  .logo { font-size: 48px; margin-bottom: 8px; }
  .roleTitle { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
  .roleSubtitle { color: var(--text2); font-size: 14px; text-align: center; }
  .roleBtn {
    width: 100%; max-width: 340px; padding: 20px 24px;
    background: var(--surface); border: 1.5px solid var(--border); border-radius: var(--radius);
    color: var(--text); font-size: 18px; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; gap: 16px; transition: all 0.2s;
  }
  .roleBtn:active { transform: scale(0.97); }
  .roleBtn.buyer { border-color: var(--accent); }
  .roleBtn.employee { border-color: var(--blue); }
  .roleBtn .roleIcon { font-size: 32px; }
  .roleBtn small { display: block; color: var(--text2); font-size: 12px; font-weight: 400; margin-top: 2px; }

  /* MAIN LAYOUT */
  #app { display: none; min-height: 100dvh; flex-direction: column; }
  #app.visible { display: flex; }

  /* HEADER */
  .header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .header-title { font-size: 18px; font-weight: 700; }
  .header-role { font-size: 11px; color: var(--accent); background: #ff6b3520; padding: 3px 8px; border-radius: 20px; }
  .header-role.emp { color: var(--blue); background: #2196f320; }
  .switchBtn { background: none; border: 1px solid var(--border); color: var(--text2); padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; }

  /* TABS */
  .tabs { display: flex; background: var(--surface); border-bottom: 1px solid var(--border); overflow-x: auto; }
  .tabs::-webkit-scrollbar { display: none; }
  .tab {
    flex: 1; min-width: 70px; padding: 12px 8px; text-align: center; font-size: 11px; font-weight: 600;
    color: var(--text2); border-bottom: 2px solid transparent; cursor: pointer; white-space: nowrap;
    transition: all 0.2s;
  }
  .tab.active { color: var(--accent); border-color: var(--accent); }
  .tab .tabIcon { font-size: 18px; display: block; margin-bottom: 2px; }
  .tab .badge {
    display: inline-block; background: var(--accent); color: white; font-size: 9px;
    width: 16px; height: 16px; border-radius: 50%; line-height: 16px; margin-left: 3px;
  }

  /* CONTENT */
  .content { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: calc(16px + var(--safe-bottom)); }
  .page { display: none; }
  .page.active { display: block; }

  /* CARDS GRID */
  .productsGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .productCard {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    overflow: hidden; display: flex; flex-direction: column;
  }
  .productCard .cardImg { background: var(--surface2); height: 100px; display: flex; align-items: center; justify-content: center; font-size: 40px; }
  .productCard .cardBody { padding: 10px; flex: 1; display: flex; flex-direction: column; gap: 4px; }
  .productCard .cardName { font-size: 13px; font-weight: 600; line-height: 1.3; }
  .productCard .cardDesc { font-size: 11px; color: var(--text2); line-height: 1.4; flex: 1; }
  .productCard .cardPrice { font-size: 15px; font-weight: 700; color: var(--accent); }
  .productCard .cardActions { display: flex; gap: 6px; padding: 8px 10px; border-top: 1px solid var(--border); }
  .btn-sm { padding: 6px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; border: none; cursor: pointer; flex: 1; }
  .btn-primary { background: var(--accent); color: white; }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-danger { background: var(--red); color: white; }
  .btn-green { background: var(--green); color: white; }
  .btn-blue { background: var(--blue); color: white; }
  .btn-sm:active { opacity: 0.8; transform: scale(0.97); }

  /* FAB */
  .fab {
    position: fixed; bottom: calc(80px + var(--safe-bottom)); right: 20px;
    width: 56px; height: 56px; border-radius: 50%; background: var(--accent); border: none;
    color: white; font-size: 26px; cursor: pointer; box-shadow: 0 4px 20px #ff6b3560;
    display: flex; align-items: center; justify-content: center; z-index: 200; transition: transform 0.2s;
  }
  .fab:active { transform: scale(0.92); }

  /* MODAL */
  .overlay {
    display: none; position: fixed; inset: 0; background: #000a; z-index: 300;
    align-items: flex-end; justify-content: center;
  }
  .overlay.open { display: flex; }
  .modal {
    background: var(--surface); border-radius: 20px 20px 0 0; width: 100%; max-width: 480px;
    padding: 24px; max-height: 90dvh; overflow-y: auto;
  }
  .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 16px; }
  .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; }

  /* FORM */
  .formGroup { margin-bottom: 14px; }
  .formGroup label { font-size: 12px; color: var(--text2); display: block; margin-bottom: 6px; }
  .formGroup input, .formGroup textarea {
    width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
    color: var(--text); padding: 12px; font-size: 14px; font-family: inherit; outline: none; resize: vertical;
  }
  .formGroup input:focus, .formGroup textarea:focus { border-color: var(--accent); }
  .formGroup textarea { min-height: 80px; }

  /* EMOJI PICKER */
  .emojiGrid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 12px; }
  .emojiOption {
    font-size: 28px; text-align: center; padding: 6px; border-radius: 8px; cursor: pointer;
    border: 2px solid transparent; transition: all 0.15s;
  }
  .emojiOption.selected { border-color: var(--accent); background: #ff6b3520; }

  /* CART */
  .cartItem {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 12px; display: flex; align-items: center; gap: 12px; margin-bottom: 10px;
  }
  .cartItemEmoji { font-size: 30px; }
  .cartItemInfo { flex: 1; }
  .cartItemName { font-size: 14px; font-weight: 600; }
  .cartItemPrice { font-size: 13px; color: var(--accent); margin-top: 2px; }
  .qtyControl { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
  .qtyBtn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--border); background: var(--surface2); color: var(--text); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .qtyNum { font-size: 15px; font-weight: 700; min-width: 20px; text-align: center; }

  /* CART SUMMARY */
  .cartSummary { background: var(--surface2); border-radius: var(--radius); padding: 16px; margin-top: 16px; }
  .cartRow { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
  .cartTotal { font-size: 20px; font-weight: 700; color: var(--accent); }
  .paymentOptions { display: flex; gap: 10px; margin-top: 12px; }
  .payOpt {
    flex: 1; padding: 12px; border-radius: 10px; border: 2px solid var(--border);
    background: var(--surface); text-align: center; font-size: 12px; font-weight: 600; cursor: pointer;
    transition: all 0.2s;
  }
  .payOpt.selected { border-color: var(--accent); background: #ff6b3515; color: var(--accent); }
  .payOpt .payIcon { font-size: 22px; display: block; margin-bottom: 4px; }

  /* ORDERS */
  .orderCard {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 14px; margin-bottom: 12px;
  }
  .orderHeader { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
  .orderNum { font-size: 13px; font-weight: 700; }
  .orderStatus { font-size: 11px; padding: 3px 8px; border-radius: 20px; }
  .status-pending { background: #ff980020; color: #ff9800; }
  .status-ready { background: #4caf5020; color: var(--green); }
  .orderInfo { font-size: 12px; color: var(--text2); margin-bottom: 10px; }
  .orderInfo span { color: var(--text); font-weight: 600; }

  /* QR */
  #qrCanvas { margin: 0 auto; display: block; }
  .qrModal { text-align: center; }
  .qrModal .orderNum { font-size: 22px; margin-bottom: 4px; }
  #qrContainer { padding: 16px; background: white; border-radius: 12px; display: inline-block; margin: 16px 0; }

  /* SCANNER */
  .scannerWrap { position: relative; border-radius: var(--radius); overflow: hidden; background: #000; }
  #scanVideo { width: 100%; display: block; }
  .scanOverlay {
    position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
  }
  .scanFrame {
    width: 200px; height: 200px; border: 2px solid var(--accent); border-radius: 12px;
    box-shadow: 0 0 0 1000px #00000060;
  }
  .scanLine {
    position: absolute; left: 0; right: 0; height: 2px; background: var(--accent);
    animation: scan 2s infinite;
  }
  @keyframes scan { 0%,100% { top: 10%; } 50% { top: 90%; } }
  .scanHint { text-align: center; color: var(--text2); font-size: 13px; margin-top: 12px; }

  /* EMPLOYEE ORDER */
  .empOrderCard {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 14px; margin-bottom: 12px;
  }
  .empOrderInfo { margin-bottom: 12px; }
  .empOrderInfoRow { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 6px; }
  .infoBadge { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 4px 10px; font-size: 12px; }
  .itemsToScan { display: flex; flex-direction: column; gap: 8px; }
  .scanItemRow {
    display: flex; align-items: center; gap: 10px; background: var(--surface2);
    border-radius: 10px; padding: 10px;
  }
  .scanItemRow.scanned { opacity: 0.5; }
  .scanItemEmoji { font-size: 24px; }
  .scanItemInfo { flex: 1; font-size: 13px; }
  .scanItemName { font-weight: 600; }
  .scanItemPrice { color: var(--text2); font-size: 11px; }
  .checkMark { font-size: 20px; }

  /* TOAST */
  .toast {
    position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 12px 20px; font-size: 14px; font-weight: 600; z-index: 999;
    opacity: 0; transition: opacity 0.3s; pointer-events: none; white-space: nowrap;
    box-shadow: 0 8px 30px #0006;
  }
  .toast.show { opacity: 1; }

  /* EMPTY */
  .empty { text-align: center; padding: 60px 20px; color: var(--text2); }
  .empty .emptyIcon { font-size: 56px; margin-bottom: 12px; }
  .empty p { font-size: 14px; }

  /* BTN FULL */
  .btn-full { width: 100%; padding: 14px; border-radius: var(--radius); font-size: 16px; font-weight: 700; border: none; cursor: pointer; margin-top: 8px; transition: all 0.2s; }
  .btn-full:active { transform: scale(0.98); }

  /* RETURN SELECTOR */
  .returnItem { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--surface2); border-radius: 10px; margin-bottom: 8px; border: 2px solid transparent; cursor: pointer; }
  .returnItem.selected { border-color: var(--red); }
  .returnCheckbox { width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 14px; background: var(--surface); }
  .returnItem.selected .returnCheckbox { background: var(--red); border-color: var(--red); color: white; }

  /* SECTION TITLE */
  .sectionTitle { font-size: 13px; font-weight: 700; color: var(--text2); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
</style>
</head>
<body>

<!-- ROLE SCREEN -->
<div id="roleScreen">
  <div class="logo">üì¶</div>
  <div class="roleTitle">–ü–í–ó –°–∏–º—É–ª—è—Ç–æ—Ä</div>
  <div class="roleSubtitle">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Ä–æ–ª—å<br>–¥–ª—è –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã</div>
  <button class="roleBtn buyer" onclick="setRole('buyer')">
    <span class="roleIcon">üõçÔ∏è</span>
    <span>
      –ü–æ–∫—É–ø–∞—Ç–µ–ª—å
      <small>–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ç–æ–≤–∞—Ä—ã, –¥–µ–ª–∞–π—Ç–µ –∑–∞–∫–∞–∑—ã</small>
    </span>
  </button>
  <button class="roleBtn employee" onclick="setRole('employee')">
    <span class="roleIcon">üë∑</span>
    <span>
      –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –ü–í–ó
      <small>–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥—ã, –≤—ã–¥–∞–≤–∞–π—Ç–µ –∑–∞–∫–∞–∑—ã</small>
    </span>
  </button>
</div>

<!-- MAIN APP -->
<div id="app">
  <div class="header">
    <div>
      <div class="header-title">üì¶ –ü–í–ó –°–∏–º—É–ª—è—Ç–æ—Ä</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <span class="header-role" id="roleLabel">–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</span>
      <button class="switchBtn" onclick="switchRole()">–°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</button>
    </div>
  </div>

  <div class="tabs" id="tabBar"></div>
  <div class="content" id="contentArea"></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- MODAL: Add/Edit Product -->
<div class="overlay" id="productModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="productModalTitle">–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</div>
    <div class="formGroup">
      <label>–ò–∫–æ–Ω–∫–∞ —Ç–æ–≤–∞—Ä–∞</label>
      <div class="emojiGrid" id="emojiGrid"></div>
    </div>
    <div class="formGroup">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input type="text" id="pName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–∞—É—à–Ω–∏–∫–∏ Sony">
    </div>
    <div class="formGroup">
      <label>–¶–µ–Ω–∞ (–æ—Ç 100 ‚ÇΩ)</label>
      <input type="number" id="pPrice" placeholder="1500" min="100">
    </div>
    <div class="formGroup">
      <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
      <textarea id="pDesc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."></textarea>
    </div>
    <button class="btn-full btn-primary" onclick="saveProduct()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    <button class="btn-full btn-secondary" onclick="closeModal('productModal')" style="margin-top:8px;">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- MODAL: Cart Checkout -->
<div class="overlay" id="checkoutModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</div>
    <div id="checkoutItems"></div>
    <div class="cartSummary" id="checkoutSummary"></div>
    <button class="btn-full btn-primary" onclick="placeOrder()" style="margin-top:16px;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
    <button class="btn-full btn-secondary" onclick="closeModal('checkoutModal')" style="margin-top:8px;">–ù–∞–∑–∞–¥</button>
  </div>
</div>

<!-- MODAL: QR Code -->
<div class="overlay" id="qrModal">
  <div class="modal qrModal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="qrModalTitle">QR-–∫–æ–¥ –∑–∞–∫–∞–∑–∞</div>
    <div id="qrContainer"><canvas id="qrCanvas"></canvas></div>
    <div id="qrOrderInfo" style="color:var(--text2);font-size:13px;margin-bottom:16px;"></div>
    <button class="btn-full btn-secondary" onclick="closeModal('qrModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- MODAL: Scanner -->
<div class="overlay" id="scanModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞</div>
    <div class="scannerWrap">
      <video id="scanVideo" autoplay playsinline muted></video>
      <div class="scanOverlay">
        <div class="scanFrame"><div class="scanLine"></div></div>
      </div>
    </div>
    <div class="scanHint">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞</div>
    <button class="btn-full btn-secondary" onclick="stopScanner()" style="margin-top:16px;">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- MODAL: Return -->
<div class="overlay" id="returnModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–û—Ñ–æ—Ä–º–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç</div>
    <div id="returnItems"></div>
    <button class="btn-full btn-danger" onclick="confirmReturn()" style="margin-top:16px;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç</button>
    <button class="btn-full btn-secondary" onclick="closeModal('returnModal')" style="margin-top:8px;">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<script>
// =========== STATE ===========
let role = 'buyer';
let products = [
  { id: 1, name: '–ù–∞—É—à–Ω–∏–∫–∏ Sony', price: 3990, desc: '–ë–µ—Å–ø—Ä–æ–≤–æ–¥–Ω—ã–µ –Ω–∞—É—à–Ω–∏–∫–∏ —Å —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ–º', emoji: 'üéß' },
  { id: 2, name: '–ß–µ—Ö–æ–ª –¥–ª—è iPhone', price: 490, desc: '–°–∏–ª–∏–∫–æ–Ω–æ–≤—ã–π –∑–∞—â–∏—Ç–Ω—ã–π —á–µ—Ö–æ–ª', emoji: 'üì±' },
  { id: 3, name: '–ó–∞—Ä—è–¥–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', price: 890, desc: '–ë—ã—Å—Ç—Ä–∞—è –∑–∞—Ä—è–¥–∫–∞ 65W', emoji: 'üîå' },
];
let cart = []; // { product, qty }
let orders = []; // { id, items, total, payment, status, cell }
let employeeOrders = []; // orders loaded via QR
let editProductId = null;
let selectedEmoji = 'üì¶';
let selectedPayment = 'delivery';
let currentReturnOrderId = null;
let scannerStream = null;
let scanInterval = null;
let returnSelected = new Set();

const EMOJIS = ['üì¶','üéß','üì±','üëü','üëú','üéÆ','üíª','‚åö','üîå','üì∑','üéÅ','üß¥','üëó','üïπÔ∏è','üìö','üçï','üß∏','üí°','üñ•Ô∏è','üéµ'];

// =========== HELPERS ===========
let productIdCounter = 10;
let orderIdCounter = 100;

function uid() { return ++productIdCounter; }
function oid() { return ++orderIdCounter; }

function showToast(msg, duration = 2500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function speak(text) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utt = new SpeechSynthesisUtterance(text);
  utt.lang = 'ru-RU';
  utt.rate = 0.95;
  window.speechSynthesis.speak(utt);
}

function formatPrice(p) { return p.toLocaleString('ru-RU') + ' ‚ÇΩ'; }

function cartCount() { return cart.reduce((s, i) => s + i.qty, 0); }
function cartTotal() { return cart.reduce((s, i) => s + i.product.price * i.qty, 0); }

// =========== ROLE ===========
function setRole(r) {
  role = r;
  document.getElementById('roleScreen').style.display = 'none';
  const app = document.getElementById('app');
  app.classList.add('visible');
  const lbl = document.getElementById('roleLabel');
  lbl.textContent = r === 'buyer' ? 'üõçÔ∏è –ü–æ–∫—É–ø–∞—Ç–µ–ª—å' : 'üë∑ –°–æ—Ç—Ä—É–¥–Ω–∏–∫';
  lbl.className = 'header-role' + (r === 'employee' ? ' emp' : '');
  renderTabs();
  renderPage(r === 'buyer' ? 'shop' : 'scanner');
}

function switchRole() {
  document.getElementById('roleScreen').style.display = 'flex';
  document.getElementById('app').classList.remove('visible');
}

// =========== TABS ===========
const buyerTabs = [
  { id: 'shop', icon: 'üè™', label: '–ú–∞–≥–∞–∑–∏–Ω' },
  { id: 'cart', icon: 'üõí', label: '–ö–æ—Ä–∑–∏–Ω–∞', badge: true },
  { id: 'orders', icon: 'üìã', label: '–ó–∞–∫–∞–∑—ã' },
];
const employeeTabs = [
  { id: 'scanner', icon: 'üì∑', label: '–°–∫–∞–Ω–µ—Ä' },
  { id: 'empOrders', icon: 'üìã', label: '–ó–∞–∫–∞–∑—ã', badge: true },
];

let currentPage = 'shop';

function renderTabs() {
  const bar = document.getElementById('tabBar');
  const tabs = role === 'buyer' ? buyerTabs : employeeTabs;
  bar.innerHTML = tabs.map(t => {
    const badgeVal = t.badge ? (role === 'buyer' ? cartCount() : employeeOrders.filter(o => o.status !== 'done').length) : 0;
    const badge = (t.badge && badgeVal > 0) ? `<span class="badge">${badgeVal}</span>` : '';
    return `<div class="tab ${currentPage === t.id ? 'active' : ''}" onclick="renderPage('${t.id}')">
      <span class="tabIcon">${t.icon}</span>${t.label}${badge}
    </div>`;
  }).join('');
}

// =========== PAGES ===========
function renderPage(pageId) {
  currentPage = pageId;
  renderTabs();
  const area = document.getElementById('contentArea');

  if (pageId === 'shop') area.innerHTML = renderShop();
  else if (pageId === 'cart') area.innerHTML = renderCart();
  else if (pageId === 'orders') area.innerHTML = renderOrders();
  else if (pageId === 'scanner') area.innerHTML = renderScannerPage();
  else if (pageId === 'empOrders') area.innerHTML = renderEmpOrders();

  // FAB
  let fab = document.getElementById('fabBtn');
  if (fab) fab.remove();
  if (pageId === 'shop') {
    const f = document.createElement('button');
    f.className = 'fab'; f.id = 'fabBtn'; f.textContent = '+';
    f.onclick = () => openProductModal(null);
    document.body.appendChild(f);
  }
}

// =========== SHOP ===========
function renderShop() {
  if (!products.length) return `<div class="empty"><div class="emptyIcon">üè™</div><p>–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.<br>–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å</p></div>`;
  return `<div class="sectionTitle">–¢–æ–≤–∞—Ä—ã</div>
  <div class="productsGrid">${products.map(p => productCardHTML(p)).join('')}</div>`;
}

function productCardHTML(p) {
  return `<div class="productCard">
    <div class="cardImg">${p.emoji}</div>
    <div class="cardBody">
      <div class="cardName">${p.name}</div>
      <div class="cardDesc">${p.desc}</div>
      <div class="cardPrice">${formatPrice(p.price)}</div>
    </div>
    <div class="cardActions">
      <button class="btn-sm btn-secondary" onclick="openProductModal(${p.id})">‚úèÔ∏è</button>
      <button class="btn-sm btn-danger" onclick="deleteProduct(${p.id})">üóëÔ∏è</button>
      <button class="btn-sm btn-primary" onclick="addToCart(${p.id})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
    </div>
  </div>`;
}

// =========== PRODUCT MODAL ===========
function openProductModal(id) {
  editProductId = id;
  const p = id ? products.find(x => x.id === id) : null;
  document.getElementById('productModalTitle').textContent = id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä' : '–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä';
  document.getElementById('pName').value = p ? p.name : '';
  document.getElementById('pPrice').value = p ? p.price : '';
  document.getElementById('pDesc').value = p ? p.desc : '';
  selectedEmoji = p ? p.emoji : 'üì¶';
  renderEmojiGrid();
  openModal('productModal');
}

function renderEmojiGrid() {
  document.getElementById('emojiGrid').innerHTML = EMOJIS.map(e =>
    `<div class="emojiOption ${e === selectedEmoji ? 'selected' : ''}" onclick="selectEmoji('${e}')">${e}</div>`
  ).join('');
}

function selectEmoji(e) {
  selectedEmoji = e;
  renderEmojiGrid();
}

function saveProduct() {
  const name = document.getElementById('pName').value.trim();
  const price = parseInt(document.getElementById('pPrice').value);
  const desc = document.getElementById('pDesc').value.trim();
  if (!name) return showToast('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
  if (!price || price < 100) return showToast('‚ö†Ô∏è –¶–µ–Ω–∞ –æ—Ç 100 ‚ÇΩ');

  if (editProductId) {
    const p = products.find(x => x.id === editProductId);
    Object.assign(p, { name, price, desc, emoji: selectedEmoji });
    showToast('‚úÖ –¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω');
  } else {
    products.push({ id: uid(), name, price, desc, emoji: selectedEmoji });
    showToast('‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
  }
  closeModal('productModal');
  renderPage('shop');
}

function deleteProduct(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
  products = products.filter(p => p.id !== id);
  cart = cart.filter(i => i.product.id !== id);
  renderPage('shop');
  showToast('üóëÔ∏è –¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω');
}

// =========== CART ===========
function addToCart(id) {
  const product = products.find(p => p.id === id);
  const existing = cart.find(i => i.product.id === id);
  if (existing) existing.qty++;
  else cart.push({ product, qty: 1 });
  showToast(`üõí ${product.name} –¥–æ–±–∞–≤–ª–µ–Ω`);
  renderTabs();
}

function renderCart() {
  if (!cart.length) return `<div class="empty"><div class="emptyIcon">üõí</div><p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p></div>`;
  return `<div class="sectionTitle">–ö–æ—Ä–∑–∏–Ω–∞ (${cartCount()} –ø–æ–∑.)</div>
  ${cart.map(i => cartItemHTML(i)).join('')}
  <div class="cartSummary">
    <div class="cartRow"><span>–ò—Ç–æ–≥–æ:</span><span class="cartTotal">${formatPrice(cartTotal())}</span></div>
    <div style="margin-top:12px;font-size:13px;color:var(--text2);margin-bottom:8px;">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</div>
    <div class="paymentOptions">
      <div class="payOpt ${selectedPayment === 'delivery' ? 'selected' : ''}" onclick="selectPayment('delivery')">
        <span class="payIcon">üíµ</span>–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏
      </div>
      <div class="payOpt ${selectedPayment === 'online' ? 'selected' : ''}" onclick="selectPayment('online')">
        <span class="payIcon">üí≥</span>–û–ø–ª–∞—Ç–∏—Ç—å —Å–µ–π—á–∞—Å
      </div>
    </div>
    <button class="btn-full btn-primary" onclick="openCheckout()" style="margin-top:12px;">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
  </div>`;
}

function cartItemHTML(i) {
  return `<div class="cartItem">
    <div class="cartItemEmoji">${i.product.emoji}</div>
    <div class="cartItemInfo">
      <div class="cartItemName">${i.product.name}</div>
      <div class="cartItemPrice">${formatPrice(i.product.price)}</div>
      <div class="qtyControl">
        <button class="qtyBtn" onclick="changeQty(${i.product.id}, -1)">‚àí</button>
        <span class="qtyNum">${i.qty}</span>
        <button class="qtyBtn" onclick="changeQty(${i.product.id}, 1)">+</button>
        <button class="qtyBtn" onclick="removeFromCart(${i.product.id})" style="margin-left:6px;font-size:12px;">üóëÔ∏è</button>
      </div>
    </div>
    <div style="font-weight:700;color:var(--accent)">${formatPrice(i.product.price * i.qty)}</div>
  </div>`;
}

function changeQty(id, delta) {
  const item = cart.find(i => i.product.id === id);
  if (!item) return;
  item.qty += delta;
  if (item.qty <= 0) cart = cart.filter(i => i.product.id !== id);
  renderPage('cart');
}

function removeFromCart(id) { cart = cart.filter(i => i.product.id !== id); renderPage('cart'); }

function selectPayment(p) { selectedPayment = p; renderPage('cart'); }

function openCheckout() {
  if (!cart.length) return;
  // Show summary in modal
  document.getElementById('checkoutItems').innerHTML = cart.map(i =>
    `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;">
      <span>${i.product.emoji} ${i.product.name} √ó ${i.qty}</span>
      <span>${formatPrice(i.product.price * i.qty)}</span>
    </div>`
  ).join('');
  document.getElementById('checkoutSummary').innerHTML = `
    <div class="cartRow"><span style="color:var(--text2)">–ü–æ–∑–∏—Ü–∏–π:</span><span>${cartCount()}</span></div>
    <div class="cartRow"><span style="color:var(--text2)">–ò—Ç–æ–≥–æ:</span><span class="cartTotal">${formatPrice(cartTotal())}</span></div>
    <div class="cartRow"><span style="color:var(--text2)">–û–ø–ª–∞—Ç–∞:</span><span>${selectedPayment === 'delivery' ? 'üíµ –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : 'üí≥ –û–ø–ª–∞—á–µ–Ω–æ –æ–Ω–ª–∞–π–Ω'}</span></div>
  `;
  openModal('checkoutModal');
}

function placeOrder() {
  const cell = Math.floor(Math.random() * 89 + 10).toString();
  const order = {
    id: oid(),
    items: cart.map(i => ({ ...i })),
    total: cartTotal(),
    payment: selectedPayment,
    status: 'pending',
    cell,
    scanned: [],
    returned: [],
  };
  orders.push(order);
  cart = [];
  closeModal('checkoutModal');
  showToast('‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!');
  renderPage('orders');
}

// =========== ORDERS ===========
function renderOrders() {
  if (!orders.length) return `<div class="empty"><div class="emptyIcon">üìã</div><p>–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p></div>`;
  return `<div class="sectionTitle">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
  ${orders.map(o => orderCardHTML(o)).join('')}`;
}

function orderCardHTML(o) {
  const payLabel = o.payment === 'delivery' ? 'üíµ –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : 'üí≥ –û–Ω–ª–∞–π–Ω';
  const statusLabel = o.status === 'ready' ? '–í—ã–¥–∞–Ω' : '–í –æ–∂–∏–¥–∞–Ω–∏–∏';
  const statusClass = o.status === 'ready' ? 'status-ready' : 'status-pending';
  return `<div class="orderCard">
    <div class="orderHeader">
      <div class="orderNum">–ó–∞–∫–∞–∑ #${o.id}</div>
      <div class="orderStatus ${statusClass}">${statusLabel}</div>
    </div>
    <div class="orderInfo">
      <span>${o.items.reduce((s,i)=>s+i.qty,0)}</span> –ø–æ–∑–∏—Ü–∏–π ¬∑ ${payLabel} ¬∑ —è—á–µ–π–∫–∞ <span>${o.cell}</span>
    </div>
    <div style="font-weight:700;color:var(--accent);margin-bottom:10px;">${formatPrice(o.total)}</div>
    <button class="btn-sm btn-secondary" onclick="showQR(${o.id})">üî≤ –ü–æ–∫–∞–∑–∞—Ç—å QR-–∫–æ–¥</button>
  </div>`;
}

// =========== QR ===========
function showQR(orderId) {
  const order = orders.find(o => o.id === orderId);
  if (!order) return;

  const qrData = JSON.stringify({
    orderId: order.id,
    cell: order.cell,
    count: order.items.reduce((s,i)=>s+i.qty,0),
    total: order.total,
    payment: order.payment,
    items: order.items.map(i => ({ id: i.product.id, name: i.product.name, price: i.product.price, qty: i.qty, emoji: i.product.emoji }))
  });

  document.getElementById('qrModalTitle').textContent = `QR-–∫–æ–¥ –∑–∞–∫–∞–∑–∞ #${order.id}`;
  document.getElementById('qrOrderInfo').textContent = `${order.items.reduce((s,i)=>s+i.qty,0)} –ø–æ–∑–∏—Ü–∏–π ¬∑ —è—á–µ–π–∫–∞ ${order.cell}`;

  openModal('qrModal');

  // Render QR after modal opens
  setTimeout(() => {
    const container = document.getElementById('qrContainer');
    container.innerHTML = '<canvas id="qrCanvas"></canvas>';
    const canvas = document.getElementById('qrCanvas');
    QRCode.toCanvas(canvas, qrData, { width: 220, margin: 1, color: { dark: '#000', light: '#fff' } });
  }, 100);
}

// =========== SCANNER ===========
function renderScannerPage() {
  return `<div class="sectionTitle">–°–∫–∞–Ω–µ—Ä QR-–∫–æ–¥–∞</div>
  <p style="color:var(--text2);font-size:13px;margin-bottom:16px;">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ –ø–æ–¥–Ω–µ—Å–∏—Ç–µ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞ –∫ –∫–∞–º–µ—Ä–µ</p>
  <button class="btn-full btn-blue" onclick="startScanner()" style="font-size:18px;padding:18px;">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥</button>`;
}

function startScanner() {
  openModal('scanModal');
  const video = document.getElementById('scanVideo');
  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(stream => {
      scannerStream = stream;
      video.srcObject = stream;
      video.play();
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      scanInterval = setInterval(() => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          if (code) {
            stopScanner();
            processQR(code.data);
          }
        }
      }, 200);
    })
    .catch(() => {
      closeModal('scanModal');
      showToast('‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
    });
}

function stopScanner() {
  clearInterval(scanInterval);
  if (scannerStream) { scannerStream.getTracks().forEach(t => t.stop()); scannerStream = null; }
  closeModal('scanModal');
}

function processQR(data) {
  try {
    const order = JSON.parse(data);
    // Check if already loaded
    const exists = employeeOrders.find(o => o.id === order.id);
    if (!exists) {
      // Normalize
      order.scanned = [];
      order.returned = [];
      order.status = 'pending';
      employeeOrders.push(order);
    }
    const payLabel = order.payment === 'delivery' ? '–æ–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : '–æ–ø–ª–∞—á–µ–Ω–æ –æ–Ω–ª–∞–π–Ω';
    const countLabel = order.count === 1 ? `${order.count} —Ç–æ–≤–∞—Ä` : order.count < 5 ? `${order.count} —Ç–æ–≤–∞—Ä–∞` : `${order.count} —Ç–æ–≤–∞—Ä–æ–≤`;
    speak(`–Ø—á–µ–π–∫–∞ ${order.cell}. ${countLabel}. ${payLabel}.`);
    showToast(`üì¶ –ó–∞–∫–∞–∑ #${order.id} –∑–∞–≥—Ä—É–∂–µ–Ω`);
    renderPage('empOrders');
  } catch(e) {
    showToast('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å QR-–∫–æ–¥');
  }
}

// =========== EMP ORDERS ===========
function renderEmpOrders() {
  const active = employeeOrders.filter(o => o.status !== 'done');
  if (!active.length) return `<div class="empty"><div class="emptyIcon">üìã</div><p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.<br>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞.</p></div>`;
  return `<div class="sectionTitle">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã (${active.length})</div>
  ${active.map(o => empOrderHTML(o)).join('')}`;
}

function empOrderHTML(o) {
  const payLabel = o.payment === 'delivery' ? 'üíµ –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : 'üí≥ –û–ø–ª–∞—á–µ–Ω–æ';
  const allScanned = o.items.every(i => o.scanned.includes(i.id) || o.returned.includes(i.id));
  const toPayItems = o.items.filter(i => !o.returned.includes(i.id));
  const toPayTotal = toPayItems.reduce((s,i) => s + i.price * i.qty, 0);

  let actionsHTML = '';
  if (allScanned) {
    const paid = o.payment === 'online' || o.returned.length > 0;
    actionsHTML = `
      ${o.returned.length > 0 && o.payment !== 'online' ? `<div style="color:var(--text2);font-size:13px;margin-bottom:8px;">–ö –æ–ø–ª–∞—Ç–µ: <b style="color:var(--accent)">${formatPrice(toPayTotal)}</b></div>` : ''}
      ${o.returned.length === 0 ? `<button class="btn-sm btn-danger" onclick="openReturn(${o.id})" style="margin-bottom:8px;width:100%;">‚Ü©Ô∏è –í–æ–∑–≤—Ä–∞—Ç</button>` : ''}
      <button class="btn-sm btn-green" onclick="completeOrder(${o.id})" style="width:100%;">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑</button>
    `;
  } else {
    actionsHTML = `<button class="btn-sm btn-danger" onclick="openReturn(${o.id})" style="width:100%;">‚Ü©Ô∏è –í–æ–∑–≤—Ä–∞—Ç</button>`;
  }

  return `<div class="empOrderCard">
    <div class="empOrderInfo">
      <div style="font-size:16px;font-weight:700;margin-bottom:8px;">–ó–∞–∫–∞–∑ #${o.id}</div>
      <div class="empOrderInfoRow">
        <div class="infoBadge">üì¶ –Ø—á–µ–π–∫–∞ ${o.cell}</div>
        <div class="infoBadge">${payLabel}</div>
        <div class="infoBadge">üí∞ ${formatPrice(o.total)}</div>
      </div>
    </div>
    <div class="sectionTitle" style="margin-bottom:8px;">–¢–æ–≤–∞—Ä—ã (–Ω–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è):</div>
    <div class="itemsToScan">
      ${o.items.map(i => {
        const scanned = o.scanned.includes(i.id);
        const returned = o.returned.includes(i.id);
        const cls = (scanned || returned) ? 'scanItemRow scanned' : 'scanItemRow';
        let mark = scanned ? '‚úÖ' : returned ? '‚Ü©Ô∏è' : '';
        let scanBtn = (!scanned && !returned) ? `<button class="btn-sm btn-primary" onclick="scanItem(${o.id},${i.id})">–°–∫–∞–Ω</button>` : '';
        return `<div class="${cls}">
          <div class="scanItemEmoji">${i.emoji}</div>
          <div class="scanItemInfo">
            <div class="scanItemName">${i.name}</div>
            <div class="scanItemPrice">${formatPrice(i.price)} √ó ${i.qty}</div>
          </div>
          <span class="checkMark">${mark}</span>
          ${scanBtn}
        </div>`;
      }).join('')}
    </div>
    <div style="margin-top:12px;">${actionsHTML}</div>
  </div>`;
}

function scanItem(orderId, itemId) {
  const order = employeeOrders.find(o => o.id === orderId);
  if (!order || order.scanned.includes(itemId)) return;
  order.scanned.push(itemId);

  const allScanned = order.items.every(i => order.scanned.includes(i.id) || order.returned.includes(i.id));
  if (allScanned) {
    speak('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–≤–∞—Ä –ø–æ–¥ –∫–∞–º–µ—Ä–æ–π.');
    showToast('üì¶ –í—Å–µ —Ç–æ–≤–∞—Ä—ã –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã');
  }
  renderPage('empOrders');
}

function openReturn(orderId) {
  currentReturnOrderId = orderId;
  returnSelected = new Set();
  const order = employeeOrders.find(o => o.id === orderId);
  const returnableItems = order.items.filter(i => !order.returned.includes(i.id));

  document.getElementById('returnItems').innerHTML = returnableItems.map(i =>
    `<div class="returnItem" id="ri_${i.id}" onclick="toggleReturn(${i.id})">
      <div class="returnCheckbox" id="rc_${i.id}"></div>
      <div style="font-size:22px;">${i.emoji}</div>
      <div style="flex:1;font-size:13px;">
        <div style="font-weight:600;">${i.name}</div>
        <div style="color:var(--text2);">${formatPrice(i.price)} √ó ${i.qty}</div>
      </div>
    </div>`
  ).join('');
  openModal('returnModal');
}

function toggleReturn(itemId) {
  if (returnSelected.has(itemId)) returnSelected.delete(itemId);
  else returnSelected.add(itemId);

  const el = document.getElementById(`ri_${itemId}`);
  const cb = document.getElementById(`rc_${itemId}`);
  if (returnSelected.has(itemId)) {
    el.classList.add('selected');
    cb.textContent = '‚úì';
  } else {
    el.classList.remove('selected');
    cb.textContent = '';
  }
}

function confirmReturn() {
  if (!returnSelected.size) { showToast('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞'); return; }
  const order = employeeOrders.find(o => o.id === currentReturnOrderId);
  returnSelected.forEach(id => {
    if (!order.returned.includes(id)) order.returned.push(id);
    order.scanned = order.scanned.filter(s => s !== id);
  });
  closeModal('returnModal');
  showToast(`‚Ü©Ô∏è –í–æ–∑–≤—Ä–∞—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω`);
  renderPage('empOrders');
}

function completeOrder(orderId) {
  const order = employeeOrders.find(o => o.id === orderId);
  order.status = 'done';
  showToast('‚úÖ –ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à—ë–Ω');
  renderPage('empOrders');
}
</script>
</body>
</html>